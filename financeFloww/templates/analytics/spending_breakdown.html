{% extends 'base.html' %}

{% block title %}Spending Breakdown - FinanceFlow{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-4">
        <div class="col-md-8">
            <h1>
                <i class="bi bi-pie-chart"></i> Spending Breakdown
            </h1>
        </div>
        <div class="col-md-4">
            <form method="get" class="row g-2">
                <div class="col-6">
                    <select name="month" class="form-select form-select-sm">
                        <option value="1" {% if month == 1 %}selected{% endif %}>January</option>
                        <option value="2" {% if month == 2 %}selected{% endif %}>February</option>
                        <option value="3" {% if month == 3 %}selected{% endif %}>March</option>
                        <option value="4" {% if month == 4 %}selected{% endif %}>April</option>
                        <option value="5" {% if month == 5 %}selected{% endif %}>May</option>
                        <option value="6" {% if month == 6 %}selected{% endif %}>June</option>
                        <option value="7" {% if month == 7 %}selected{% endif %}>July</option>
                        <option value="8" {% if month == 8 %}selected{% endif %}>August</option>
                        <option value="9" {% if month == 9 %}selected{% endif %}>September</option>
                        <option value="10" {% if month == 10 %}selected{% endif %}>October</option>
                        <option value="11" {% if month == 11 %}selected{% endif %}>November</option>
                        <option value="12" {% if month == 12 %}selected{% endif %}>December</option>
                    </select>
                </div>
                <div class="col-6">
                    <input type="number" name="year" class="form-control form-control-sm" value="{{ year }}" min="2020" max="2100">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-sm w-100">
                        <i class="bi bi-search"></i> View
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Summary -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-body">
                    <h5>{{ month_name }} - Total Expenses: <span class="text-danger">${{ total_expenses }}</span></h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Distribution</h5>
                </div>
                <div class="card-body">
                    <canvas id="breakdownChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Table -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Categories</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Category</th>
                                <th>Amount</th>
                                <th>%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for category in categories %}
                                <tr>
                                    <td>{{ category.category__name }}</td>
                                    <td>${{ category.total }}</td>
                                    <td><strong>{{ category.percentage }}%</strong></td>
                                </tr>
                            {% empty %}
                                <tr>
                                    <td colspan="3" class="text-center text-muted py-4">
                                        No data for selected period
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>
        </div>
    </div>
</div>

<script>
    {% if categories %}
        const breakdownCtx = document.getElementById('breakdownChart').getContext('2d');
        new Chart(breakdownCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for cat in categories %}'{{ cat.category__name }}'{{ ", " if not forloop.last }}{% endfor %}],
                datasets: [{
                    data: [{% for cat in categories %}{{ cat.total }}{{ ", " if not forloop.last }}{% endfor %}],
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                        '#FF9F40', '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    {% endif %}
</script>
{% endblock %}